# TODO
import sys
from pathlib import Path
from os import listdir
from snakemake.utils import min_version
import subprocess

# Set minimum version of snakemake to work with
min_version("8.20")


# Load configuration files
configfile: "config/config.yaml"
configfile: "config/target.yaml"

# Read target directory and set working tree
TARGET_DIR = Path(config["GENES_DIR"])
PREFIX = config["PREFIX"]
OUTDIR = Path(config["OUTDIR"])
PATHFIXCORE = Path(OUTDIR/"PREPROCESING")
PATHALN = Path(PATHFIXCORE/"ALN")
PATHCONS = Path(PATHFIXCORE/"CONS")
PATHCURATED = Path(OUTDIR/"DEF_GENES")
PATHPHYLO = Path(OUTDIR/"PHYLO")
LOGDIR = OUTDIR/"LOGS"

# Create directories
directories = [OUTDIR, PATHFIXCORE, PATHALN, PATHCONS, PATHCURATED, PATHPHYLO]
for directory in directories:
    directory.mkdir(parents=True, exist_ok=True)

# Useful functions
def iter_gene_names():
    for file in listdir(TARGET_DIR):
        yield file.replace(config["EXTENSION"], "")
        
# Include rules
include: "rules/msa.smk"
include: "rules/phylo.smk"
include: "rules/fixcore.smk"
include: "rules/trimal.smk"

# Set final file
rule all:
    input:
        PATHPHYLO/f"{PREFIX}.treefile"
